services:

  # -- PostgreSQL ----------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: maintainer
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: maintainer
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - secrets_data:/run/secrets:ro
    depends_on:
      init-secrets:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maintainer"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Not exposed to the host — only reachable from the server container.

  # -- Init: generate shared secrets once ----------------------------------
  # Runs before postgres + server start. Creates the shared password file
  # in the secrets volume if it doesn't exist yet.
  init-secrets:
    image: alpine:3.19
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ ! -f /secrets/postgres_password ]; then
          apk add --no-cache openssl > /dev/null 2>&1
          PW=$$(openssl rand -base64 24 | tr -d '+/=\n' | head -c 32)
          echo "$$PW" > /secrets/postgres_password
          chmod 600 /secrets/postgres_password
          echo "[init-secrets] Generated postgres_password."
        else
          echo "[init-secrets] postgres_password already exists, skipping."
        fi
    volumes:
      - secrets_data:/secrets

  # -- ControlSphere Server (Next.js + WebSocket) -------------------------
  server:
    image: ghcr.io/timexx/controlsphere:latest
    # To build locally instead of pulling the image, comment out 'image' and
    # uncomment the two lines below:
    # build:
    #   context: ./server
    #   dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # All secrets are auto-generated — override via environment if needed.
      NODE_ENV: production
      PORT: 3000
      # Override Docker's automatic HOSTNAME (container-ID) so the server
      # binds to 0.0.0.0 and is reachable via the host port mapping.
      HOSTNAME: "0.0.0.0"
    volumes:
      - secrets_data:/app/.secrets
      - agent_downloads:/app/public/downloads
    depends_on:
      init-secrets:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
  secrets_data:
  agent_downloads:
