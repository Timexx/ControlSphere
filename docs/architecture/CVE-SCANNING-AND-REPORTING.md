# CVE Scanning & Reporting (ISO Alignment)

## Overview
- Adds a persistent CVE mirror plus package-level vulnerability matching to surface risk in near-real time.
- Runs an automated mirror against OSV every 2 hours, scoped to installed package ecosystems.
- Tracks matched CVEs per package/machine and raises security events for high/critical issues.
- UI surfaces: `/security/[id]` now shows matched CVEs, and the App Shell highlights global critical counts.

## Data Model
- `Cve`: Canonical CVE/OSV record with severity, score, affected package ranges, timestamps.
- `VulnerabilityMatch`: Join between `VMPackage` and `Cve`, scoped to a `machineId`; deduped per CVE/package.
- `CveMirrorState`: Single row tracking mirror status/last sync/error for operational visibility.

## Services
- **Mirror (`src/services/cve-mirror.ts`)**
  - Interval: 2h (configurable), kicked off during server bootstrap.
  - Pulls installed packages + ecosystems, batches `POST https://api.osv.dev/v1/querybatch`, upserts CVEs, writes mirror state.
  - Severity derived from CVSS score if present; safely guards re-entrancy.
- **Matcher (`src/services/vulnerability-scanner.ts`)**
  - Normalizes package manager → OSV ecosystem; supports semver and non-semver (Debian-style) comparisons.
  - Matches against parsed OSV affected ranges (`introduced`/`fixed`/`last_affected`) or explicit vulnerable versions.
  - Writes `VulnerabilityMatch` rows, removes stale matches, returns match stats for alerting.

## API & Event Flow
- **Agent Scan (`api/agent/scan`)**
  - After package upsert/cleanup, runs `scanPackages` to refresh matches.
  - Creates/updates vulnerability `SecurityEvent` when high/critical matches exist; real-time events reuse existing bus.
  - Response now includes vulnerability counts.
- **VM Security Detail (`api/vms/[id]/security`)**
  - Returns vulnerability matches (with CVE + package context) alongside events, audit logs, ports, scans.
- **Global Summary (`api/security/vulnerabilities`)**
  - Aggregates critical/high match counts and affected machines for the App Shell indicator.

## UI Surfaces
- **Security Detail**: New “Vulnerabilities” section lists CVE ID (links to NVD/OSV), severity badge, affected package/version, description, CVSS score, and detection time.
- **App Shell**: Header indicator shows live critical/high counts and deep-links to `/security`.

## Verification
- Automated: `npm test src/services/vulnerability-scanner.test.ts` validates range matching, explicit version matching, and ecosystem mapping.
- Manual:
  1) Trigger mirror (`startCveMirrorService`) or wait for 2h cycle; inspect `Cve`/`CveMirrorState` via Prisma Studio.
  2) POST a scan payload with a known vulnerable version; confirm `VulnerabilityMatch` rows and a `vulnerability` security event for high/critical.
  3) Open `/security/[id]` to verify the vulnerability list renders and the App Shell counter reflects critical totals.

## ISO 27001 Notes
- Continuous vulnerability monitoring (A.12, A.14) via scheduled mirror + agent scans with audit trails in `SecurityEvent`.
- Data minimization: mirror limited to installed package ecosystems; results pruned per package/machine association.
- Operational monitoring: mirror state recorded for incident response; high/critical issues surfaced prominently to support timely remediation SLAs.
