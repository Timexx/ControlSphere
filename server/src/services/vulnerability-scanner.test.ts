import { describe, expect, it } from 'vitest'
import type { Cve } from '@prisma/client'
import { isCveAffectingPackage, isVersionInRange, mapManagerToEcosystem, type PackageInfo } from './vulnerability-scanner'

function buildCve(affected: any, overrides?: Partial<Cve>): Cve {
  return {
    id: overrides?.id || 'CVE-TEST-0001',
    description: overrides?.description || null,
    severity: overrides?.severity || 'high',
    score: overrides?.score ?? null,
    publishedAt: overrides?.publishedAt || new Date(),
    affected: JSON.stringify(affected),
    createdAt: overrides?.createdAt || new Date(),
    updatedAt: overrides?.updatedAt || new Date()
  } as unknown as Cve
}

describe('vulnerability-scanner helpers', () => {
  it('matches semver ranges with introduced/fixed bounds', () => {
    const cve = buildCve([
      {
        package: { name: 'express', ecosystem: 'npm' },
        ranges: [{ type: 'ECOSYSTEM', events: [{ introduced: '1.0.0' }, { fixed: '2.0.0' }] }]
      }
    ])

    const vulnerablePkg: PackageInfo = {
      id: 'pkg-1',
      machineId: 'machine-1',
      name: 'express',
      version: '1.8.0',
      manager: 'npm'
    }

    const safePkg: PackageInfo = { ...vulnerablePkg, version: '2.1.0' }

    expect(isCveAffectingPackage(cve, vulnerablePkg)).toBe(true)
    expect(isCveAffectingPackage(cve, safePkg)).toBe(false)
  })

  it('matches last_affected ranges inclusively', () => {
    const range = { events: [{ introduced: '3.0.0' }, { last_affected: '3.2.1' }] }
    expect(isVersionInRange('3.2.1', range)).toBe(true)
    expect(isVersionInRange('3.3.0', range)).toBe(false)
  })

  it('honors explicit vulnerable versions even when not semver', () => {
    const cve = buildCve([
      {
        package: { name: 'openssl', ecosystem: 'Debian' },
        versions: ['1.1.1-1']
      }
    ])

    const vulnerablePkg: PackageInfo = {
      id: 'pkg-2',
      machineId: 'machine-1',
      name: 'openssl',
      version: '1.1.1-1',
      manager: 'apt'
    }

    expect(isCveAffectingPackage(cve, vulnerablePkg)).toBe(true)
  })

  it('maps package managers to expected OSV ecosystems', () => {
    expect(mapManagerToEcosystem('npm')).toBe('npm')
    expect(mapManagerToEcosystem('apt')).toBe('Debian')
    expect(mapManagerToEcosystem('cargo')).toBe('crates.io')
    expect(mapManagerToEcosystem('composer')).toBe('Packagist')
  })
})
