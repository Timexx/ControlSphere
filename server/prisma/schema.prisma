// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  username    String   @unique
  password    String
  role        String   @default("user") // admin, user, viewer
  active      Boolean  @default(true)
  language    String?  // User's preferred language (e.g., 'en', 'de')
  lastLoginAt DateTime?
  createdBy   String?  // ID of admin who created this user (null for initial setup user)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  auditLogs     AuditLog[]
  machineAccess UserMachineAccess[]
}

model UserMachineAccess {
  id         String   @id @default(cuid())
  userId     String
  machineId  String
  assignedAt DateTime @default(now())
  assignedBy String   // ID of admin who assigned access

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([userId, machineId])
  @@index([userId])
  @@index([machineId])
}

model Machine {
  id              String   @id @default(cuid())
  hostname        String
  ip              String
  osInfo          String?  @db.Text // JSON string: { distro, version, kernel }
  status          String   @default("offline") // online, offline, error
  lastSeen        DateTime @default(now())
  secretKey       String?  @unique // DEPRECATED: Will be removed after migration
  secretKeyHash   String?  @unique // Hashed secret key for authentication
  secretVersion   Int      @default(1) // For secret rotation support
  secretRotatedAt DateTime? // Timestamp of last secret rotation
  notes           String?  @db.Text
  createdBy       String?  // ID of user who registered/added this machine
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  metrics      Metric[]
  commands     Command[]
  ports        Port[]
  links        MachineLink[]
  tags         MachineTag[]
  jobExecutions JobExecution[]
  groupMembers GroupMember[]
  auditLogs    AuditLog[]
  packages     VMPackage[]
  packageScans PackageScan[]
  policyAssignments PolicyAssignment[]
  securityEvents SecurityEvent[]
  vulnerabilityMatches VulnerabilityMatch[]
  scanProgress ScanProgressState? @relation("MachineScanProgress")
  userAccess   UserMachineAccess[]
  
  @@index([status])
  @@index([lastSeen])
}

model Metric {
  id          String   @id @default(cuid())
  machineId   String
  machine     Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  cpuUsage    Float    // Percentage
  ramUsage    Float    // Percentage
  ramTotal    Float    // GB
  ramUsed     Float    // GB
  diskUsage   Float    // Percentage
  diskTotal   Float    // GB
  diskUsed    Float    // GB
  uptime      Int      // Seconds
  
  timestamp   DateTime @default(now())
  
  @@index([machineId, timestamp])
}

model Command {
  id          String   @id @default(cuid())
  machineId   String
  machine     Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  command     String   @db.Text
  output      String?  @db.Text
  exitCode    Int?
  status      String   @default("pending") // pending, running, completed, failed
  
  createdAt   DateTime @default(now())
  completedAt DateTime?
  
  @@index([machineId, createdAt])
}

model MachineTag {
  id         String   @id @default(cuid())
  machineId  String
  machine    Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  key        String
  value      String
  createdAt  DateTime @default(now())

  @@index([machineId])
  @@index([key, value])
}

model Port {
  id          String   @id @default(cuid())
  machineId   String
  machine     Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  
  port        Int
  proto       String   // tcp, udp
  service     String   // Service name
  state       String   // LISTEN, ESTABLISHED, etc.
  
  lastSeen    DateTime @default(now())
  
  @@unique([machineId, port, proto])
  @@index([machineId])
}

model MachineLink {
  id          String   @id @default(cuid())
  machineId   String
  machine     Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)

  title       String
  url         String
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([machineId, createdAt])
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("static") // static | dynamic
  query       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     GroupMember[]
  jobs        Job[]
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  machineId String
  createdAt DateTime @default(now())

  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([groupId, machineId])
  @@index([machineId])
}

model Job {
  id           String   @id @default(cuid())
  name         String
  description  String?
  command      String
  mode         String   @default("parallel") // parallel | rolling
  status       String   @default("PENDING")  // PENDING, RUNNING, SUCCESS, FAILED, ABORTED
  targetType   String   @default("adhoc")    // adhoc | group | dynamic
  groupId      String?
  targetQuery  String?
  strategy     String?
  totalTargets Int      @default(0)
  createdByUserId String?  // null = legacy job created before multi-user support
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  group       Group?          @relation(fields: [groupId], references: [id], onDelete: SetNull)
  executions  JobExecution[]

  @@index([status])
  @@index([createdAt])
}

model JobExecution {
  id          String   @id @default(cuid())
  jobId       String
  machineId   String
  status      String   @default("PENDING") // PENDING, RUNNING, SUCCESS, FAILED, SKIPPED, ABORTED
  output      String?  @db.Text
  exitCode    Int?
  error       String?  @db.Text
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  job     Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([machineId])
}

model AuditLog {
  id        String   @id @default(cuid())
  machineId String?
  userId    String?
  action    String   // LOGIN, COMMAND_EXEC, SHELL_OPEN, SHELL_CLOSE, AGENT_EVENT, SESSION_CREATED, SESSION_ENDED, RATE_LIMIT_EXCEEDED
  eventType String?  // For secure terminal events: SESSION_CREATED, SESSION_ENDED, RATE_LIMIT_EXCEEDED, REPLAY_DETECTED, HMAC_FAILED
  details   String?  @db.Text // JSON string with additional event data
  severity  String   @default("info") // info, warn, critical
  createdAt DateTime @default(now())

  machine Machine? @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([machineId, createdAt])
  @@index([action])
  @@index([eventType])
}

model VMPackage {
  id         String   @id @default(cuid())
  machineId  String
  name       String
  version    String
  manager    String?  // apt, yum, rpm, apk, etc.
  status     String   @default("installed") // installed, update_available, security_update
  cveIds     String?  @db.Text
  lastSeen   DateTime @default(now())
  scanId     String?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  scan    PackageScan? @relation(fields: [scanId], references: [id], onDelete: SetNull)
  vulnerabilityMatches VulnerabilityMatch[]

  @@unique([machineId, name])
  @@index([machineId, status])
  @@index([machineId, lastSeen])
}

model PackageScan {
  id          String      @id @default(cuid())
  machineId   String
  source      String      @default("agent")
  summary     String?  @db.Text
  createdAt   DateTime    @default(now())

  machine     Machine     @relation(fields: [machineId], references: [id], onDelete: Cascade)
  packages    VMPackage[]

  @@index([machineId, createdAt])
}

model ScanProgressState {
  machineId  String   @id
  progress   Int
  phase      String
  etaSeconds Int?
  startedAt  DateTime
  updatedAt  DateTime @updatedAt

  machine Machine @relation("MachineScanProgress", fields: [machineId], references: [id], onDelete: Cascade)
}

model SecurityPolicy {
  id             String   @id @default(cuid())
  name           String
  targetPath     String
  policyType     String   @default("config") // config, integrity
  expectedHash   String?
  expectedContent String?  @db.Text
  intervalSeconds Int     @default(300)
  severity       String   @default("medium") // low, medium, high, critical
  mode           String   @default("observe") // observe, enforce, baseline
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  assignments PolicyAssignment[]
  events      SecurityEvent[]

  @@index([policyType])
  @@index([targetPath])
}

model PolicyAssignment {
  id         String   @id @default(cuid())
  policyId   String
  machineId  String
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())

  policy  SecurityPolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  machine Machine        @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([policyId, machineId])
  @@index([machineId])
}

model SecurityEvent {
  id         String   @id @default(cuid())
  machineId  String
  policyId   String?
  type       String   // drift, integrity, vulnerability, audit
  severity   String   @default("medium")
  message    String   @db.Text
  data       String?  @db.Text
  status     String   @default("open") // open, ack, resolved
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  machine Machine        @relation(fields: [machineId], references: [id], onDelete: Cascade)
  policy  SecurityPolicy? @relation(fields: [policyId], references: [id], onDelete: SetNull)

  @@index([machineId, status])
  @@index([machineId, createdAt])
  @@index([policyId])
}

model Cve {
  id          String   @id // e.g. "CVE-2024-1234" or OSV IDs
  description String?  @db.Text
  severity    String
  score       Float?
  publishedAt DateTime
  affected    String?  @db.Text // JSON payload of affected packages and ranges
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  matches     VulnerabilityMatch[]

  @@index([id])
  @@index([severity])
  @@index([publishedAt])
}

model VulnerabilityMatch {
  id          String   @id @default(cuid())
  cveId       String
  packageId   String
  machineId   String
  createdAt   DateTime @default(now())
  cve         Cve       @relation(fields: [cveId], references: [id])
  package     VMPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  machine     Machine   @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([cveId, packageId])
  @@index([machineId])
}

model CveMirrorState {
  id        String   @id @default("global")
  lastSync  DateTime
  status    String   // syncing, idle, error
  error     String?  @db.Text
  mode      String   @default("full") // full | scoped
  ecosystems String?  @db.Text // JSON array of mirrored ecosystems
  totalCves Int?
}

model ServerConfig {
  id        String   @id @default("global")
  serverUrl String?  // e.g. "http://192.168.10.10:3000" â€” set during initial setup
  updatedAt DateTime @updatedAt
}
